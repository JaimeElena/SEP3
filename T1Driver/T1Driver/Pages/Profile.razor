@page "/Profile"
@using T1Driver.Models
@using T1Driver.Data
@using T1Driver.Authentication
@using System.Threading
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
<h3>Profile</h3>
<AuthorizeView>
    <NotAuthorized>
        <h3>You need to login before access!</h3>
    </NotAuthorized>
        <ChildContent Context="another_name">
            <Authorized>
                @{
                    Initialize();
                }
                <EditForm Model="CurrentUser" OnValidSubmit="SaveEdit">
                    <DataAnnotationsValidator/>
                    <ValidationSummary/>
                    <div class="form-group">
                        Username:<br/>
                        <InputTextArea @bind-Value="CurrentUser.username"/>
                    </div>
                    <div class="form-group">
                        Password:<br/>
                        <InputTextArea @bind-Value="CurrentUser.password"/>
                    </div>
                    <div class="form-group">
                        First Name:<br/>
                        <InputTextArea @bind-Value="CurrentUser.firstName"/>
                    </div>
                    <div class="form-group">
                        Last Name:<br/>
                        <InputTextArea @bind-Value="CurrentUser.lastName"/>
                    </div>
                    <div class="form-group">
                        Birthday:<br/>
                        <InputDate @bind-Value="CurrentUser.birthday" @bind-Value:format="dd/MM/yyyy"/>
                    </div>
                    <div class="form-group"> Gender:
                        <select class="form-control selectpicker" @onchange="arg => ChangeGender(arg)">
                            <option>Male</option>
                            <option>Female</option>
                        </select>
                    </div>
                    <p class="actions">
                        <button class="btn btn-outline-dark" type="submit">Save</button>
                    </p>
                    <button class="btn btn-outline-dark" @onclick="Initialize">Reset</button>
                    <button class="btn btn-outline-dark" @onclick="PerformLogout">Logout</button>
                </EditForm>
            </Authorized>
        </ChildContent>
</AuthorizeView>

@code {
    private Driver CurrentUser;

    private string message;
    private int id;
    private string username;
    private string password;
    private string firstName;
    private string lastName;
    private DateTime birthday;
    private string sex;
    
    

    IUserServices client = new UserServices();
    
    private void PerformLogout()
    {
        message = "Logout Succeed!";
        username = "";
        password = "";
        try
        {
            ((UserAuthenticationStateProvider) AuthenticationStateProvider).Logout();
            message = "Logout succeed!";
            Thread.Sleep(3000);
            NavigationManager.NavigateTo("/");
        }
        catch (Exception e)
        {
            message = e.Message;
        }
    }

    private void Initialize()
    {
        CurrentUser = ((UserAuthenticationStateProvider) AuthenticationStateProvider).GetUser();
        id = CurrentUser.id;
        username = CurrentUser.username;
        password = CurrentUser.password;
        firstName = CurrentUser.firstName;
        lastName = CurrentUser.lastName;
        birthday = CurrentUser.birthday;
        sex = CurrentUser.sex;
    }
    
    private void ChangeGender(ChangeEventArgs args)
    {
        CurrentUser.sex = null;
        try
        {
            CurrentUser.sex = args.Value.ToString();
        }
        catch (Exception e){}
        
    }

    private void SaveEdit()
    {
        try
        {
            client.EditDriver(id, username, password, firstName, lastName, birthday, sex);
            message = "Change saved!";
            Thread.Sleep(1000);
        }
        catch (Exception e)
        {
            message = e.Message;
        }
    }
}