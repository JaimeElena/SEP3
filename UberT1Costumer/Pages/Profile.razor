@page "/Profile"
@using UberT1Costumer.Models
@using UberT1Costumer.Data
@using UberT1Costumer.Authentication
@using System.Threading
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IOrderingService OrderingService

<h3>Profile</h3>
<AuthorizeView>
    <NotAuthorized>
        <h3>You need to login before access!</h3>
    </NotAuthorized>
        <ChildContent Context="another_name">
            <Authorized>
                @{
                    Initialize();
                }
                @{
                    if (show)
                    {
                        <div class="form-group">
                            Username:<br/>
                            <label>@username</label>
                        </div>
                        <div class="form-group">
                            Password:<br/>
                            <label>@password</label>
                        </div>
                        <div class="form-group">
                            First name:<br/>
                            <label>@firstName</label>
                        </div>
                        <div class="form-group">
                            Last name:<br/>
                            <label>@secondName</label>
                        </div>
                        <div class="form-group">
                            Birthday:<br/>
                            <label>@birthday</label>
                        </div>
                        <div class="form-group">
                            Gender:<br/>
                            <label>@sex</label>
                        </div>
                        @if (showMessage)
                        {
                            <div style="color:red">@message</div>
                        }
                        <button class="btn btn-outline-dark" @onclick="@(() => {Hidden();ShowEdit();})">Edit</button>
                        <button @onclick="@ShowHistory">Show History</button>
                    }
                }

                @{
                    if (showEdit)
                    {
                        <EditForm Model="CurrentUser" OnValidSubmit="SaveEdit">
                            <DataAnnotationsValidator/>
                            <ValidationSummary/>
                            <div class="form-group">
                                Username:<br/>
                                <InputTextArea @bind-Value="CurrentUser.username"/>
                            </div>
                            <div class="form-group">
                                Password:<br/>
                                <InputTextArea @bind-Value="CurrentUser.password"/>
                            </div>
                            <div class="form-group">
                                First Name:<br/>
                                <InputTextArea @bind-Value="CurrentUser.firstname"/>
                            </div>
                            <div class="form-group">
                                Last Name:<br/>
                                <InputTextArea @bind-Value="CurrentUser.secondname"/>
                            </div>
                            <div class="form-group">
                                Birthday:<br/>
                                <InputDate @bind-Value="CurrentUser.birthday" @bind-Value:format="dd/MM/yyyy"/>
                            </div>
                            <div class="form-group"> Gender:
                                <select class="form-control selectpicker" @onchange="arg => ChangeGender(arg)">
                                    <option>Male</option>
                                    <option>Female</option>
                                </select>
                            </div>
                            @if (showMessage)
                            {
                                <div style="color:red">@message</div>
                            }
                            <p class="actions">
                                <button class="btn btn-outline-dark" type="submit">Save</button>
                            </p>
                            <button class="btn btn-outline-dark" @onclick="@(() => {Initialize();CancelEdit();Show();})">Cancel</button>
                        </EditForm>
                    }
                }
                
                @if (showHistory)
                {
                    @if (orders == null)
                    {
                        <p><em>Loading......</em></p>
                    }
                    else if (!orders.Any())
                    {
                        <p><em>No history requests exist now.</em></p>
                    }
                    else if (orders.Any())
                    {
                        <table class="table">
                            <thead>
                            <tr>
                                <td>Driver</td>
                                <td>Customer</td>
                                <td>Destination</td>
                                <td>Distance</td>
                                <td>Estimated Time</td>
                                <td>Price</td>
                                <td>Status</td>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var item in orders)
                            {
                                <tr>
                                    <td>@item.driver.firstname @item.driver.secondname</td>
                                    <td>@item.customer.firstname @item.customer.secondname</td>
                                    <td>@item.destinationStreetName</td>
                                    <td>@item.distance</td>
                                    <td>@item.estimatedTime</td>
                                    <td>@item.price</td>
                                    <td>@item.status</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                        <button @onclick="@HideHistory">Back to Profile</button>
                    }
                }
            </Authorized>
        </ChildContent>
</AuthorizeView>

@code {
    private Costumer CurrentUser;

    private string message;
    private int id;
    private string username;
    private string password;
    private string firstName;
    private string secondName;
    private string birthday;
    private string sex;
    private bool showMessage;
    private bool showHistory;
    private IList<Order> orders;

    private bool show = true;
    private bool showEdit;
    
    private Task Initialize()
    {
        CurrentUser = ((UserAuthenticationStateProvider) AuthenticationStateProvider).GetUser();
        id = CurrentUser.id;
        username = CurrentUser.username;
        password = CurrentUser.password;
        firstName = CurrentUser.firstname;
        secondName = CurrentUser.secondname;
        birthday = CurrentUser.birthday;
        sex = CurrentUser.sex;
        if (username == "" || password == "" || firstName == "" || secondName == "" || birthday == "" || sex == null)
        {
            message = "You should fill up all your information!";
            ShowMessage();
        }
        return null;
    }
    
    private void ChangeGender(ChangeEventArgs args)
    {
        CurrentUser.sex = null;
        try
        {
            CurrentUser.sex = args.Value.ToString();
        }
        catch (Exception e){}
        
    }

    private async Task SaveEdit()
    {
        try
        {
            if (username == "" || password == "" || firstName == "" || secondName == "" || birthday == "" || sex == null)
            {
                message = "You should fill up all your information!";
                ShowMessage();
            }
            else
            {
                CurrentUser = await ((UserAuthenticationStateProvider) AuthenticationStateProvider).EditUser(CurrentUser);
                message = "Change saved!";
                await Task.WhenAll(Initialize(), CancelEdit());
                Show();
            }
        }
        catch (Exception e)
        {
            message = e.Message;
        }
    }

    private void Show()
    {
        show = true;
    }

    private void Hidden()
    {
        show = false;
    }

    private void ShowEdit()
    {
        showEdit = true;
    }

    private Task CancelEdit()
    {
        showEdit = false;
        Initialize();
        return null;
    }

    private void ShowMessage()
    {
        showMessage = true;
    }

    private async Task ShowHistory()
    {
        orders = await OrderingService.GetHistory(CurrentUser);
        show = false;
        showHistory = true;
    }

    private void HideHistory()
    {
        showHistory = false;
        show = true;
    }
}